<!DOCTYPE html>
<html lang="en">
<head>
    <title>webproject</title>
    <script>
        function addZero(a){
            if(a<10){
                a=`0${a}`;
            }
            else{
                a=a.toString();
            }
            return a;
        }

        function setClock(){
            let newTime = new Date();
            let hour = newTime.getHours();
            let min = newTime.getMinutes();
            let sec = newTime.getSeconds();
            if(hour>12){
                hour-=12;
                document.getElementById("am").innerHTML="PM";
            }
            else if(hour==0){
                hour=12;
                document.getElementById("am").innerHTML="AM";
            }
            else{
                document.getElementById("am").innerHTML="AM";
            }
            document.getElementById("time").innerHTML=`${addZero(hour)}:${addZero(min)}`;
            document.getElementById("sec").innerHTML=addZero(sec);
        }

        function setDate(){
            let newDate = new Date();
            let year = newDate.getFullYear();
            let month = newDate.getMonth()+1;
            let date = newDate.getDate();
            let dayIndex = newDate.getDay();
            let day;
            if(dayIndex==0){
                day="일";
            }
            else if(dayIndex==1){
                day="월";
            }
            else if(dayIndex==2){
                day="화";
            }
            else if(dayIndex==3){
                day="수";
            }
            else if(dayIndex==4){
                day="목";
            }
            else if(dayIndex==5){
                day="금";
            }
            else if(dayIndex==6){
                day="토";
            }
            document.getElementById("date").innerHTML=`${year}년 ${month}월 ${date}일 ${day}요일`;
        }

        function rate(num,type){
            if(type=="pm2_5"){
                if(num<=15){
                    return "좋음";
                }
                else if(num<=35){
                    return "보통";
                }
                else if(num<=75){
                    return "나쁨";
                }
                else{
                    return "매우나쁨";
                }
            }
            else if(type=="pm10"){
                if(num<=30){
                    return "좋음";
                }
                else if(num<=80){
                    return "보통";
                }
                else if(num<=150){
                    return "나쁨";
                }
                else{
                    return "매우나쁨";
                }
            }
            else if(type=="co"){
                if(num<=9400){
                    return "좋음";
                }
                else if(num<=12400){
                    return "보통";
                }
                else if(num<=15400){
                    return "나쁨";
                }
                else{
                    return "매우나쁨";
                }
            }
            else if(type=="o3"){
                if(num<=100){
                    return "좋음";
                }
                else if(num<=140){
                    return "보통";
                }
                else if(num<=180){
                    return "나쁨";
                }
                else{
                    return "매우나쁨";
                }
            }
            else if(type=="so2"){
                if(num<=80){
                    return "좋음";
                }
                else if(num<=250){
                    return "보통";
                }
                else if(num<=350){
                    return "나쁨";
                }
                else{
                    return "매우나쁨";
                }
            }
            else if(type=="no2"){
                if(num<=70){
                    return "좋음";
                }
                else if(num<=150){
                    return "보통";
                }
                else if(num<=200){
                    return "나쁨";
                }
                else{
                    return "매우나쁨";
                }
            }
        }

        async function getWeather(lat, lng, isAllowed) {
            const key="e89d6cbebe4567f9679d37643de972fd";
            const city="Seoul";
            const data = [];
            let url1,url2;
            let imageUrl;
            let sunset_time,sunrise_time;
            const conditionDescription = {200: '비를 동반한 천둥구름', 201: '가벼운 비를 동반한 천둥구름', 202: '폭우를 동반한 천둥구름', 210: '약한 천둥구름', 211: '천둥구름', 212: '강한 천둥구름', 221: '불규칙한 천둥구름', 230: '약한 안개를 동반한 천둥구름', 231: '안개를 동반한 천둥구름', 232: '강한 안개비를 동반한 천둥구름', 300: '가벼운 안개비', 301: '안개비', 302: '강한 안개비', 310: '가벼운 비', 311: '적은비', 312: '강한 적은비', 313: '소나기와 안개비', 314: '강한 소나기와 안개비', 321: '소나기', 500: '약한 비', 501: '중간 비', 502: '강한 비', 503: '매우 강한 비', 504: '폭우', 511: '우박', 520: '약한 소나기', 521: '소나기', 522: '강한 소나기', 531: '불규칙적 소나기', 600: '가벼운 눈', 601: '눈', 602: '강한 눈', 611: '진눈깨비', 612: '소나기성 진눈깨비', 615: '약한 비와 눈', 616: '비와 눈', 620: '약한 소나기성 눈', 621: '소나기성 눈', 622: '강한 소나기성 눈', 701: '약한 안개', 711: '안개', 721: '안개', 731: '황사', 741: '안개', 751: '황사', 761: '미세먼지', 762: '화산재', 771: '돌풍', 781: '토네이도', 800: '구름 한 점 없는 맑은 하늘', 801: '약간의 구름이 낀 하늘', 802: '드문드문 구름이 낀 하늘', 803: '구름이 거의 없는 하늘', 804: '구름으로 뒤덮인 흐린 하늘', 900: '토네이도', 901: '태풍', 902: '허리케인', 903: '한랭', 904: '고온', 905: '바람부는', 906: '우박', 951: '바람이 거의 없는', 952: '약한 바람', 953: '부드러운 바람', 954: '중간 세기 바람', 955: '신선한 바람', 956: '센 바람', 957: '돌풍에 가까운 센 바람', 958: '돌풍', 959: '심각한 돌풍', 960: '폭풍', 961: '강한 폭풍', 962: '허리케인'};
            try {
                if(isAllowed){
                    url1 = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lng}&appid=${key}`;
                    url2 = `http://api.openweathermap.org/data/2.5/air_pollution?lat=${lat}&lon=${lng}&appid=${key}`;
                }
                else{
                    url1 = `https://api.openweathermap.org/data/2.5/weather?q=${city}&appid=${key}`;
                    url2 = `http://api.openweathermap.org/data/2.5/air_pollution?lat=37.5683&lon=126.9778&appid=${key}`
                }

                const weatherResponse = await fetch(url1);
                const weatherJson = await weatherResponse.json();

                const microResponse = await fetch(url2);
                const microJson = await microResponse.json();

                data.push(weatherJson);
                data.push(microJson);

                imageUrl=data[0].weather[0].icon;
                sunrise_time = new Date(data[0].sys.sunrise*1000);
                sunset_time = new Date(data[0].sys.sunset*1000);

                document.getElementById("icon").src=`./icon/${imageUrl}.png`;
                document.getElementById("location").innerHTML=data[0].name;
                document.getElementById("temp").innerHTML=Math.round(data[0].main.temp -273.15)+"°C";
                document.getElementById("tempMaxMin").innerHTML=`${Math.round(data[0].main.temp_max-273.15)}°/${Math.round(data[0].main.temp_min-273.15)}°`;
                document.getElementById("feelLike").innerHTML=`체감온도:${Math.round(data[0].main.feels_like-273.15)}°`;
                document.getElementById("detailCondition").innerHTML=conditionDescription[data[0].weather[0].id];

                document.getElementById("pm2.5_value").innerHTML=`${rate(data[1].list[0].components.pm2_5,"pm2_5")} ${data[1].list[0].components.pm2_5.toFixed(1)}μg/m³`;
                document.getElementById("pm10_value").innerHTML=`${rate(data[1].list[0].components.pm10,"pm10")} ${data[1].list[0].components.pm10.toFixed(1)}μg/m³`;
                document.getElementById("co_value").innerHTML=`${rate(data[1].list[0].components.co,"co")} ${data[1].list[0].components.co.toFixed(1)}μg/m³`;
                document.getElementById("nh3_value").innerHTML=`${data[1].list[0].components.nh3.toFixed(1)}μg/m³`;
                document.getElementById("o3_value").innerHTML=`${rate(data[1].list[0].components.o3,"o3")} ${data[1].list[0].components.o3.toFixed(1)}μg/m³`;
                document.getElementById("so2_value").innerHTML=`${rate(data[1].list[0].components.so2,"so2")} ${data[1].list[0].components.so2.toFixed(1)}μg/m³`;
                document.getElementById("no2_value").innerHTML=`${rate(data[1].list[0].components.no2,"no2")} ${data[1].list[0].components.no2.toFixed(1)}μg/m³`;
                document.getElementById("humidity_value").innerHTML=`${data[0].main.humidity}%`;
                document.getElementById("wind_value").innerHTML=`${data[0].wind.speed}m/s`;
                document.getElementById("sunrise_value").innerHTML=`오전 ${sunrise_time.getHours()}:${sunrise_time.getMinutes()}`;
                document.getElementById("sunset_value").innerHTML=`오후 ${sunset_time.getHours()-12}:${sunset_time.getMinutes()}`;

                if(data[0].weather[0].main=="Thunderstorm"){
                    document.getElementById("condition").innerHTML="뇌우";
                }
                else if(data[0].weather[0].main=="Drizzle"){
                    document.getElementById("condition").innerHTML="이슬비";
                }
                else if(data[0].weather[0].main=="Rain"){
                    document.getElementById("condition").innerHTML="비";
                }
                else if(data[0].weather[0].main=="Snow"){
                    document.getElementById("condition").innerHTML="눈";
                }
                else if(data[0].weather[0].main=="Clear"){
                    document.getElementById("condition").innerHTML="맑음";
                }
                else if(data[0].weather[0].main=="Clouds"){
                    document.getElementById("condition").innerHTML="구름";
                }
                else if(data[0].weather[0].main=="Haze"){
                    document.getElementById("condition").innerHTML="안개";
                }
                else if(data[0].weather[0].main=="Mist"){
                    document.getElementById("condition").innerHTML="안개";
                }
                console.log(data);
                return data;
            } catch (error) {
                console.error("api값 접근 중 error 발생", error.message);
            }
        }

        async function userLocation(position) {
            let userLat = position.coords.latitude;
            let userLng = position.coords.longitude;
            await getWeather(userLat, userLng, true);
        }

        async function unallowed() {
            await getWeather(null, null, false);
        }

        function hide(){
            document.getElementById("location").style.visibility='hidden';
            document.getElementById("tempMaxMin").style.visibility='hidden';
            document.getElementById("feelLike").style.visibility='hidden';
            document.getElementById("detailCondition").style.visibility='hidden';
            document.getElementById("location").style.visibility='hidden';
            document.getElementById("sidePanel").style.visibility='hidden';
            document.getElementById("location_icon").style.visibility='hidden';
        }

        function onMouse(){
            document.getElementById("icon").style.right=220+"px";
            document.getElementById("icon").style.top=30+"px";
            document.getElementById("temp").style.right=100+"px";
            document.getElementById("temp").style.top=40+"px";
            document.getElementById("location_icon").style.left=document.getElementById("location").clientWidth+"px";
            document.getElementById("condition").style.visibility='hidden';
            document.getElementById("detailCondition").style.visibility='visible';
            document.getElementById("location").style.visibility='visible';
            document.getElementById("feelLike").style.visibility='visible';
            document.getElementById("tempMaxMin").style.visibility='visible';
            document.getElementById("sidePanel").style.visibility='visible';
            document.getElementById("location_icon").style.visibility='visible';
        }

        function mouseOut(){
            document.getElementById("icon").style.right=145+"px";
            document.getElementById("icon").style.top=20+"px";
            document.getElementById("temp").style.right=25+"px";
            document.getElementById("temp").style.top=20+"px";
            document.getElementById("location_icon").style.left=document.getElementById("location").clientWidth+"px";
            document.getElementById("condition").style.visibility='visible';
            document.getElementById("detailCondition").style.visibility='hidden';
            document.getElementById("location").style.visibility='hidden';
            document.getElementById("feelLike").style.visibility='hidden';
            document.getElementById("tempMaxMin").style.visibility='hidden';
            document.getElementById("sidePanel").style.visibility='hidden';
            document.getElementById("location_icon").style.visibility='hidden';
        }

    window.onload = function () {
        hide();
        unallowed();//사용자가 위치허용을 하지 않았을때 날씨 정보를 띄우기 위한 함수 호출
        setClock();//시계 호출
        setDate();//날자 호출
        setInterval(setClock, 100);//0.1초마다 시계호출
        setInterval(setDate, 1000);//1초마다 날자호출
        navigator.geolocation.getCurrentPosition(userLocation);//유저 위치정보 허가 메세지 보내고 허용시 좌표받기 함수 호출
    }
    </script>
    <link rel="stylesheet" href="webproject.css">
</head>
<body style="font-family: 'roboto', sans-serif;" onselectstart="return false" ondragstart="return false" oncontextmenu="return false">
    <div id="container">
        <div id="clock">
            <div id="time"></div>
            <div id="am"></div>
            <div id="sec"></div>
            <div id="date"></div>
        </div>
        <div id="weather" onmouseover="onMouse()" onmouseout="mouseOut()">
            <div id="location"></div>
            <img id="location_icon" src="./icon/pin.png"></img>
            <img id="icon"></img>
            <div id="temp"></div>
            <div id="condition"></div>
            <div id="tempMaxMin"></div>
            <div id="feelLike"></div>
            <div id="detailCondition"></div>
            <div id="sidePanel">
                <div id="pm2_5">
                    <p id="pm2.5_title">초미세먼지</p>
                    <div id="pm2.5_value"></div>
                </div>
                <div id="pm10">
                    <p id="pm10_title">미세먼지</p>
                    <div id="pm10_value"></div>
                </div>
                <div id="co">
                    <p id="co_title">일산화탄소</p>
                    <div id="co_value"></div>
                </div>
                <div id="so2">
                    <p id="so2_title">이산화황</p>
                    <div id="so2_value"></div>
                </div>
                <div id="no2">
                    <p id="no2_title">이산화질소</p>
                    <div id="no2_value"></div>
                </div>
                <div id="nh3">
                    <p id="nh3_title">암모니아</p>
                    <div id="nh3_value"></div>
                </div>
                <div id="o3">
                    <p id="o3_title">오존</p>
                    <div id="o3_value"></div>
                </div>
                <div id="humidity">
                    <img id="humidity_icon" src="./icon/humidity.png"></img>
                    <p id="humidity_title" style="display: inline;">습도</p>
                    <div id="humidity_value"></div>
                </div>
                <div id="wind">
                    <img id="wind_icon" src="./icon/wind.png"></img>
                    <p id="wind_title" style="display: inline;">풍속</p>
                    <div id="wind_value"></div>
                </div>
                <div id="sunrise">
                    <img id="sunrise_icon" src="./icon/sunrise.png"></img>
                    <p id="sunrise_title" style="display: inline;">일출</p>
                    <div id="sunrise_value"></div>
                </div>
                <div id="sunset">
                    <img id="sunset_icon" src="./icon/sunset.png"></img>
                    <p id="sunset_title" style="display: inline;">일몰</p>
                    <div id="sunset_value"></div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>